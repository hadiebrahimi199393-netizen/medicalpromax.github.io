<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- متاتگ اینماد (طبق پنل) -->
    <meta name="enamad" content="61081844" />
    <title>آزمون‌یار پزشکی | Medical ProMax</title>
    
    <!-- فونت وزیرمتن و تیلویند -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- آیکون‌ها -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #f0f4f8;
            user-select: none; /* جلوگیری از کپی کردن متن سوالات */
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .option-card {
            transition: all 0.2s;
        }
        .option-card:hover:not(:disabled) {
            transform: translateX(-5px);
            background-color: #eff6ff;
        }
        /* استایل اسکرول بار */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
 

            const container = document.getElementById('app-container');
            
            container.innerHTML = `
                <div class="max-w-3xl mx-auto fade-in pb-20">
                    <div class="flex justify-between items-center mb-4 text-sm text-gray-500">
                        <span>سوال ${qIndex + 1} از ${totalQ}</span>
                        <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">
                            ${questionsDB[currentState.subjectId].title}
                        </span>
                    </div>

                    <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8 mb-6">
                        <h3 class="text-xl font-bold text-gray-800 leading-9 mb-6 text-justify">
                            ${questionData.q}
                        </h3>

                        <div class="space-y-3" id="options-container">
                            ${questionData.options.map((opt, idx) => `
                                <button onclick="handleAnswer(${idx})" 
                                    id="btn-opt-${idx}"
                                    class="option-card w-full text-right p-4 rounded-xl border-2 border-gray-200 hover:border-blue-300 bg-gray-50 text-gray-700 font-medium flex items-center gap-3">
                                    <div class="w-8 ه-8 rounded-full border-2 border-gray-300 flex items-center justify-center text-sm font-bold text-gray-400 shrink-0">
                                        ${['الف', 'ب', 'ج', 'د'][idx]}
                                    </div>
                                    <span>${opt}</span>
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <div id="feedback-area" class="hidden fade-in bg-white rounded-xl shadow border-r-4 p-6 mb-6">
                        <!-- محتوا با JS پر می‌شود -->
                    </div>

                    <div class="fixed bottom-0 left-0 right-0 p-4 bg-white border-t shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] flex justify-end">
                         <div class="container mx-auto max-w-3xl flex justify-between items-center">
                            <div class="text-sm font-bold text-gray-400">
                                ${currentState.examType === 'residency' ? 'آزمون دستیاری ۵۲' : 'آزمون آزمایشی'}
                            </div>
                            <button id="next-btn" onclick="nextQuestion()" disabled 
                                class="bg-gray-300 text-white px-8 py-3 rounded-xl font-bold transition flex items-center gap-2">
                                <span>سوال بعدی</span>
                                <i data-lucide="chevron-left" class="w-5 ه-5"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        // بررسی پاسخ
        function handleAnswer(selectedIndex) {
            const qIndex = currentState.currentQuestionIndex;
            const questionData = currentState.questionsList[qIndex];
            const correctIndex = questionData.correct;
            const optionsContainer = document.getElementById('options-container');
            const feedbackArea = document.getElementById('feedback-area');
            const nextBtn = document.getElementById('next-btn');

            currentState.answers[qIndex] = {
                selected: selectedIndex,
                correct: correctIndex
            };

            if (selectedIndex === correctIndex) currentState.score++;

            const buttons = optionsContainer.querySelectorAll('button');
            buttons.forEach(btn => btn.disabled = true);

            const selectedBtn = document.getElementById(`btn-opt-${selectedIndex}`);
            const correctBtn = document.getElementById(`btn-opt-${correctIndex}`);
            const selectedBadge = selectedBtn.querySelector('div');
            const correctBadge = correctBtn.querySelector('div');

            if (selectedIndex !== correctIndex) {
                selectedBtn.classList.remove('bg-gray-50', 'border-gray-200');
                selectedBtn.classList.add('bg-red-50', 'border-red-500', 'text-red-700');
                selectedBadge.classList.remove('border-gray-300', 'text-gray-400');
                selectedBadge.classList.add('border-red-500', 'bg-red-500', 'text-white');
                selectedBadge.innerHTML = '<i data-lucide="x" class="w-4 ه-4"></i>';
            }

            correctBtn.classList.remove('bg-gray-50', 'border-gray-200');
            correctBtn.classList.add('bg-green-50', 'border-green-500', 'text-green-700', 'shadow-md');
            correctBadge.classList.remove('border-gray-300', 'text-gray-400');
            correctBadge.classList.add('border-green-500', 'bg-green-500', 'text-white');
            correctBadge.innerHTML = '<i data-lucide="check" class="w-4 ه-4"></i>';

            feedbackArea.classList.remove('hidden');
            feedbackArea.classList.add(selectedIndex === correctIndex ? 'border-green-500' : 'border-red-500');
            
            feedbackArea.innerHTML = `
                <div class="flex items-start gap-3">
                    <div class="mt-1 ${selectedIndex === correctIndex ? 'text-green-600' : 'text-red-600'}">
                        <i data-lucide="${selectedIndex === correctIndex ? 'check-circle' : 'alert-circle'}" class="w-6 ه-6"></i>
                    </div>
                    <div>
                        <h4 class="font-bold text-lg mb-2 ${selectedIndex === correctIndex ? 'text-green-800' : 'text-red-800'}">
                            ${selectedIndex === correctIndex ? 'پاسخ صحیح!' : 'پاسخ نادرست'}
                        </h4>
                        <p class="text-gray-700 leading-7">
                            <span class="font-bold text-gray-900">گزینه صحیح:</span> ${questionData.options[correctIndex]}
                        </p>
                        ${questionData.note ? `
                            <div class="mt-3 text-sm text-gray-600 bg-gray-100 p-3 rounded-lg border border-gray-200">
                                <span class="font-bold text-blue-600">نکته آموزشی:</span> ${questionData.note}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;

            nextBtn.disabled = false;
            nextBtn.classList.remove('bg-gray-300');
            nextBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            if (qIndex === currentState.questionsList.length - 1) {
                nextBtn.querySelector('span').innerText = "مشاهده کارنامه";
            }

            lucide.createIcons();
        }

        function nextQuestion() {
            if (currentState.currentQuestionIndex < currentState.questionsList.length - 1) {
                currentState.currentQuestionIndex++;
                renderQuestion();
            } else {
                renderResult();
            }
        }

        // 4. نمایش کارنامه
        function renderResult() {
            currentState.view = 'result';
            const total = currentState.questionsList.length;
            const score = currentState.score;
            const percent = Math.round((score / total) * 100);
            
            let message = "";
            let colorClass = "";
            if (percent >= 70) { 
                message = "عالی! تسلط خوبی دارید."; 
                colorClass = "text-green-600"; 
            } else if (percent >= 50) { 
                message = "خوب است، اما نیاز به مرور دارید."; 
                colorClass = "text-yellow-600"; 
            } else { 
                message = "نیاز به مطالعه بیشتر دارید."; 
                colorClass = "text-red-600"; 
            }

            const container = document.getElementById('app-container');
            container.innerHTML = `
                <div class="max-w-xl mx-auto text-center fade-in pt-10">
                    <div class="bg-white rounded-3xl shadow-xl p-8 mb-6">
                        <div class="w-24 ه-24 rounded-full ${percent >= 50 ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'} mx-auto flex items-center justify-center mb-6">
                            <i data-lucide="${percent >= 50 ? 'award' : 'frown'}" class="w-12 ه-12"></i>
                        </div>
                        
                        <h2 class="text-3xl font-bold text-gray-800 mb-2">نتیجه آزمون</h2>
                        <p class="text-gray-500 mb-6">${questionsDB[currentState.subjectId].title} - ${currentState.examType === 'residency' ? 'آزمون دستیاری' : 'آزمون پره'}</p>
                        
                        <div class="text-5xl font-black ${colorClass} mb-4">${percent}%</div>
                        <p class="font-medium text-gray-700 mb-8">${message}</p>
                        
                        <div class="grid grid-cols-2 gap-4 mb-8">
                            <div class="bg-green-50 p-4 rounded-xl border border-green-100">
                                <div class="text-green-600 font-bold text-xl">${score}</div>
                                <div class="text-green-800 text-sm">پاسخ صحیح</div>
                            </div>
                            <div class="bg-red-50 p-4 rounded-xl border border-red-100">
                                <div class="text-red-600 font-bold text-xl">${total - score}</div>
                                <div class="text-red-800 text-sm">پاسخ نادرست</div>
                            </div>
                        </div>

                        <div class="flex flex-col gap-3">
                            <button onclick="startExam('${currentState.examType}')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition">
                                آزمون مجدد
                            </button>
                            <button onclick="selectSubject('${currentState.subjectId}')" class="w-full bg-white border-2 border-gray-200 hover:bg-gray-50 text-gray-700 font-bold py-3 rounded-xl transition">
                                بازگشت به منوی آزمون‌ها
                            </button>
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        // ناوبری بازگشت
        function goBack() {
            if (currentState.view === 'exam-select') {
                renderHome();
            } else if (currentState.view === 'quiz' || currentState.view === 'result') {
                if (confirm("آیا مطمئن هستید؟ پیشرفت شما از بین می‌رود.")) {
                    selectSubject(currentState.subjectId);
                }
            }
        }

        function goHome() {
            if (currentState.view !== 'home') {
                if (currentState.view === 'quiz') {
                    if (confirm("آیا مطمئن هستید؟ آزمون لغو می‌شود.")) {
                        renderHome();
                    }
                } else {
                    renderHome();
                }
            }
        }

        // شروع برنامه
        renderHome();

    </script>
</body>
</html>

